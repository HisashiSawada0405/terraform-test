# terraform-test.yml
#   å¯¾è±¡ãƒ–ãƒ©ãƒ³ãƒã®å¯¾è±¡ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã§ terraform plan ã‚’å®Ÿè¡Œã—ã€çµæžœã‚’ artifact ã¨ã—ã¦ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹
#   å¯¾è±¡ãƒ–ãƒ©ãƒ³ãƒã® pull request ãŒ open ã®å ´åˆã€ pull request ã« plan çµæžœã‚’ã‚³ãƒ¡ãƒ³ãƒˆã¨ã—ã¦æ›¸ãè¾¼ã‚€

name: terraform plan

on:
  workflow_dispatch:
    inputs:
      target_branch:
        description: 'target branch (ex. feature/KP-0000)'
        required: true
      target_terraform_directory:
        description: 'target terraform directory (ex. terraform/environments/dev)'
        required: true

env:
  TERRAFORM_VERSION: 1.3.6  # .terraform-version ã¨åŒã˜
  WORKING_DIRECTORY: ${{ github.event.inputs.target_terraform_directory }}
  AWS_REGION: ap-northeast-1
  TZ: 'Asia/Tokyo'

permissions:
  id-token: write
  contents: read

jobs:
  terraform-plan:
    permissions: write-all
    defaults:
      run:
        shell: bash
        working-directory: ${{ env.WORKING_DIRECTORY }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Set current datetime as env variable
        run: echo "CURRENT_DATETIME=$(date +'%Y-%m-%d_%H-%M-%S')" >> $GITHUB_ENV

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-region: ${{ env.AWS_REGION }}
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}  # é–‹ç™ºç’°å¢ƒã¯ä»Šã®ã¨ã“ã‚è‡ªåˆ†ã®IAMã®ã‚¢ã‚¯ã‚»ã‚¹ã‚­ãƒ¼ã‚’åˆ©ç”¨ã—ã¦ã„ã‚‹ãŸã‚
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Config Terraform plugin cache
        run: |
          echo 'plugin_cache_dir="$HOME/.terraform.d/plugin-cache"' >~/.terraformrc
          mkdir --parents ~/.terraform.d/plugin-cache

      - name: Cache Terraform  # ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç’°å¢ƒã§ã¯Cacheã¯å‹•ä½œã—ãªã„
        uses: actions/cache@v3
        with:
          path: |
            ~/.terraform.d/plugin-cache
          key: ${{ runner.os }}-terraform-${{ hashFiles('**/.terraform.lock.hcl') }}
          restore-keys: |
            ${{ runner.os }}-terraform-

      - name: Terraform Init
        id: init
        run: terraform init

      - name: Terraform Plan
        id: plan
        run: |
          terraform plan -no-color -out tfplan_${{ env.CURRENT_DATETIME }} > tfplan.log
          cat tfplan.log
        continue-on-error: true

      - name: Upload plan result as artifact
        uses: actions/upload-artifact@v3
        with:
          name: tfplan_${{ env.CURRENT_DATETIME }}
          path: ${{ env.WORKING_DIRECTORY }}/tfplan_${{ env.CURRENT_DATETIME }}

      - name: Upload plan log as artifact
        uses: actions/upload-artifact@v3
        with:
          name: tfplan.log
          path: ${{ env.WORKING_DIRECTORY }}/tfplan.log

      - name: Update Pull Request if exists
        uses: actions/github-script@v6
        env:
          PLAN: "${{ steps.plan.outputs.stdout }}"
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // Retrieve context.issue.number for selected branch
            // https://github.com/actions/github-script/issues/203
            const issues = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              head: `${context.repo.owner}:${{ github.event.inputs.target_branch }}`
            })
            
            // create comment if pull request exists
            if (issues.data.length) {
              const pr_number = context.issue.number || issues.data[0].number

              // create comment
              const output = `#### Terraform Plan ðŸ“–\`${{ steps.plan.outcome }}\`
              <details><summary>Show Plan</summary>
  
              \`\`\`\n
              ${process.env.PLAN}
              \`\`\`
  
              </details>
  
              *Pushed by: @${{ github.actor }}, Action: \`${{ github.event_name }}\`*`;
  
              github.rest.issues.createComment({
                issue_number: pr_number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: output
              })
            }
